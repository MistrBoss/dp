% ============================================================================ %
% Encoding: UTF-8 (žluťoučký kůň úpěl ďábelšké ódy)
% ============================================================================ %

% ============================================================================ %
\nn{Úvod}
První odstavec pod nadpisem se neodsazuje, ostatní ano (pouze první řádek, odsazení vertikální mezy odstavci je typycké pro anglickou sazbu; czech babel toto respektuje, netřeba do textu přidávat jakékoliv explicitní formátování, viz ukázka sazby tohoto textu s následujícím odstavcem).

Formátování druhého odstavce. Text text text text text text text text text text text text.


% ============================================================================ %
\cast{Teoretická část}

\n{1}{Použité analytické metody}

\n{2}{Diferenční analýza}
Diferenční analýzu (někdy též Gap analýza) navrhl Igor Ansoff. Skládá se z následujících kroků:
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Popis stávajícího stavu}
	\item{Stanovení cílů (popis cílového stavu)}
	\item{Určení rozdílu (mezery) mezi stávajícím a cílovým stavem}
	\item{Návrh variant dosažení cílového stavu (alternativní strategie)}
	\item{Zhodnocení variant a výběr nevhodnější z nich}
	\item{V případě potřeby se celý postup opakuje, dokud není dosaženo cílového stavu}
\end{itemize}

\n{1}{Klasifikace řešených oblastí}
TODO: navodit téma + uvézt základní škálu

\n{2}{Konstruktivní změny fotografie}
TODO: definovat konstruktivní změny

\n{3}{Návrh řešení}
Křížová korelace zrychlená pomocí diskrétní Fourierovy transformace.
TODO: rozvést

\n{3}{Oblast zájmu}
TODO: uvézt

\n{4}{Změny vlastností}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Změna barev; TODO: Popis změny barev}
	\item{Změna kontrastu;TODO: Popis změny kontrastu}
	\item{Změna jasu;TODO: Popis změny jasu}
\end{itemize}

\n{4}{Změny obsahu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Vodotisk}
	\item{Logo}
	\item{Šum}
\end{itemize}

\n{2}{Destruktivní změny fotografie}
TODO: definovat destruktivní změny

\n{3}{Návrh řešení}
Výpočet Hausdorfovy vzdálenosti mezi konvexními polyedry, které reprezentující hrany v obrazu.
TODO: rozvést

\n{3}{Oblast zájmu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Změna komprese (rozmazaná fotka)}
	\item{Změny rozlišení}
	\begin{itemize}
		\item{Ořez (v jedné nebo obou dimenzích}
		\item{Deformace (v jedné nebo obou dimenzích)}
	\end{itemize}
\end{itemize}

\n{2}{Kombinace konstruktivních a destruktivních změn}
TODO: Obecně je porovnání problematické, rozvést.

\n{3}{Návrh řešení}
Redukce fotografie na její prahovou velikost jako příprava na křížovou korelaci viz konstruktivní změny.

\n{3}{Oblast zájmu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Asymetrická změna obou stran s čímkoliv}
	\item {Změna kvality v důsledku zhoršeni komprese s čímkoliv}
	\item {Logo nebo vodotisk v kombinaci s předcházejícími}
\end{itemize}

\n{2}{Výběr reprezentativního vzorku}
Pro skupinu vzájemně si podobných fotografií vybereme nejvhodnějšího kandidáta, který bude následně ostatní fotografie zastupovat.

\n{3}{Návrh řešení}
Pro tyto účely zavedeme koeficient podobnosti, který zjednodušeně určíme jako VELIKOST × OSTROST + JAS. Výsledek bude na intervalu <0, 1>. Hodnoty blížící se nule mají nejnižší koeficient zastupitelnosti a naopak hodnoty blížící se 1 mají nejvyšší koeficient zastupitelnosti. 

\n{3}{Oblast zájmu}

\n{4}{Střední hodnota jasu}
Pouze zohlednění zda fotka není příliš jasná nebo příliš tmavá, jednoduchý algoritmus

\n{4}{Poměrný počet hran}
Test “rozmazanosti” fotky, konvoluce s vhodným (nutné testování) jádrem typu horní propust (s celkovým součtem 0) - tedy výsledek neutrální podklad z kterého “vystupují” hrany, velké množství hran ⇔ fotka není rozmazaná

\n{4}{Rozlišení fotografie}
Pouze klasická velikost fotky (větší ⇔ lepší).

\n{1}{Další nadpis}
Tato sekce obsahuje ukázku vložení obrázku (Obr. \ref{fig:logo}).

% Obrázek lze vkládat pomocí následujícího zjednodušeného stylu, nebo klasickým LaTex způsobem
% Pozor! Obrázek nesmí obsahovat alfa kanál (průhlednost). Jde to proti standardu PDF/A.
\obr{Popisek obrázku}{fig:logo}{0.5}{graphics/logo/fai_logo_cz.png}


\n{2}{Podnadpis}
Tato sekce obsahuje ukázku vložení tabulky (Tab. \ref{tab:priklad}).

% Tabulku lze vkládat pomocí následujícího zjednodušeného stylu, nebo klasickým LaTex způsobem
\tab{Popisek tabulky}{tab:priklad}{0.65}{|l|c|c|c|c|c|r|}{
  \hline
   & 1 & 2 & 3 & 4 & 5 & Cena [Kč] \\ \hline
  \emph{F} & (jedna) & (dva) & (tři) & (čtyři) & (pět) & 300 \\ \hline
}

\n{3}{Podpodnadpis}

\n{3}{Podpodnadpis}
Citace knihy. \cite{chmel}


% ============================================================================ %

% Pokud Vaše práce neobsahuje analytickou část, stačí odstranit či zakomentovat nasledujících pár rádků
\cast{Analytická část}

\n{1}{Brainstorming}
Analytický metoda sloužící ke sběru myšlenek, námětů a případné zevrubné konstruktivní kritice dané problematiky. V rámci této práce byla použita v akademickém a profesním kruhu pro identifikaci základních ukazatelů pro další kroky analýzy.

\n{2}{Akademický kruh}
Diskutovány zejména technické možnosti. Kde a jak lze vůbec porovnání fotografií provádět strojově. K další analýze vyly vyb

\n{2}{Profesní kruh}
V kruhu s provozovatelem byly kladeny nejvyšší nároky na flexibilitu a propustnost celého řešení.

\n{1}{Diferenční analýza (GAP analýza)}

\n{2}{Popis současného stavu}
Je požadováno porovnání rastrových bitmap za účelem identifikace vzájemně podobných fotografií. Řešení je hledáno pro produkční provoz. Konzumentem cílového řešení je webový portál dovolena.cz, který má přibližně dva miliony fotografií. Průměrný počet přístupů k některé fotografii je přibližně 100 přístupů za sekundu. Jedná se především o hotely a jejich okolí. Webový portál slouží spíše jako datový konsolidátor. Nabídka portálu značně ovlivňuje cílové portfolio fotografií. Podle testovacích měření se za jeden týden obmění cca 10\% fotografií z celkového množství. Jako testovací vzorek byl vybrán jeden nejmenovaný hotel a jeho 139 fotografií. Zákazník webového portálu vidí všechny fotografie v nesetříděné galerii. Některé fotografie jsou unikátní, ale většina si je velmi podobná. U některý dokonce nejsou lidským okem patrné rozdíly.

\n{2}{Popis cílového stavu}
Konsolidované fotografie prezentované klientovi budou v maximální možné míře obsahovat unikátní fotografie. Vzájemně si podobné fotografie budou odfiltrovány a zůstane pouze jedna a to fotografie s nejvyšším indexem zastupitelnosti. Klient nebude čekat na zpracování podobnosti obrázků. Buď budou zpracované, pak klient uvidí jen unikáty, nebo ne a pak uvidí vše v původním stavu. V takovém případě se poměrově zvýší priorita na výpočet podobnosti fotek tohoto hotelu vůči ostatním ve frontě na výpočet. Cílové řešení musí být schopno operovat řádově s jednotkami milionů fotografií s týdenní fluktuací 15\%.

\n{3}{Nefunkční požadavky}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Bezúdržbový systém}
	\item {Nevyžadující v průběhu času další financování}
	\item {Minimální vstupní investice}
	\item {Maximální kompatibility s aktuálním HW}
\end{itemize}

\n{2}{Rozdíly}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Nově vznikne nástroj pro určení koeficientu podobnosti dvou fotografií.}
	\item {Nově vznikne nástroj pro určení koeficientu zastupitelnosti vzájemně si podobných fotografií.}
	\item {Fotografie jednoho hotelu budou oindexovány a vnitřně škálovány do skupin pomocí koeficientů výše.}
	\item {Dojde k navýšení celkového počtu fotografií.}
	\item {Zvýší se také fluktuace fotografií (na očekávaných 15\%).}
\end{itemize}

\n{2}{Návrh variant k dosažení cíle}
Pilířem celého řešení bude backendová strana cílového konzumenta. Limity a také jednotlivé možnosti pro realizaci jsou velmi omezeny nutností integrovat do současného řešení. Nejen z těchto důvodů má serverová strana spíše podpůrný charakter v projektu jako celku. Její význam je spíše v propojení všech jednotlivých komponent. Dojde tedy k modifikaci existujícího produkčního server-side prostředí. Nově zde poběží služba, která bude
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {poskytovat zadání na určení koeficientů podobnosti a zastupitelnosti,}
	\item {poskytovat metadata nezbytná pro distribuci výpočtu,}
	\item {konzumovat výsledek distribuované operace,}
	\item {kompletovat zpracovaná data do cache vhodné pro silný organický provoz.}
\end{itemize}
Naopak klientská strana je naprosto autonomní. Pro realizaci lze použít jak libovolnou platformu, tak libovolné technologie. Jediným technickým limitem je schopnost standardizovaným způsobem komunikovat se serverovou stranou.

\n{3}{Výpočet koeficientů na CPU}
Základní myšlenka je využít nejdostupnější produkční HW a na zavedeném serveru spustit novou službu. Hlavní výhodou je dostupnost produkčního HW ve vlastním datacentru cílového konzumenta. Podstatnou nevýhodou fakt, že pro určení koeficientů výše není CPU ideální platforma.

\n{3}{Výpočet koeficientů na CPU s paralelizací na GPU}
Základní myšlenka je osadit do produkčního serveru pracovní grafickou kartu a počítat podobnost fotografií na GPU.

\n{3}{Výpočet koeficientů na PC farmě}
Základní myšlenka je využít HW osobních PC, kterých je v každé větší firmě požehnaně a neprovádět výpočet na jednom stroji, na každém dostupném stroji.

\n{2}{Zhodnocení variant}
Zhodnocení vychází z benchmarkingu, který byl vyhodnocen jako pomocná analýza.

\n{3}{Výpočet koeficientů na CPU}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Za necelých 6 dní spočítá týdenní přírůstek.}
	\item {Za zbylou dobu z týdenního cyklu dále vypočítá přibližně 3,7\% z celkového objemu sto milionu koeficientů.}
	\item {Pro plné vypočítání všech koeficientů potřebuje dalších cca 27 týdnů.}
	\item {Rezerva pro další růst (navýšení celkového počtu fotografií) je cca 18\%.}
\end{itemize}

\n{3}{Výpočet koeficientů na CPU s paralelizací na GPU}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Za necelých 8 hodin spočítá týdenní přírůstek.}
	\item {Za část ze zbylé doby týdenního cyklu dále vypočítá 100\% z celkového objemu sto milionu koeficientů.}
	\item {Pro plné vypočítání všech koeficientů potřebuje celkem 2 dny.}
	\item {Rezerva pro další růst (navýšení celkového počtu fotografií) je cca 300\%.}
\end{itemize}

\n{1}{Benchmarking}
Jednotlivé kandidáty pro realizaci klientské části (rozvedené v GAP analýze) podrobíme výkonnostním a srovnávacím testům.
Základní předpoklady:
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Řádově je celkem potřeba jednorázově odbavit 100 000 000 výpočtů obou koeficientů.}
	\item {Na týdenní bázi následně odbavovat denní přírůstky (řádově 15 000 000 výpočtů obou koeficientů).}
	\item {Na denní bázi je to tedy něco přes 2 000 000 výpočtů obou koeficientů.}
\end{itemize}

\n{2}{Testovací prostředí}

\n{3}{Použitý HW}
Při volbě HW k testování byla zvolena pracovní stanice Lenovo, která je svoji sestavou velmi blízko produkčnímu serveru. Vzhledem k tomu, že disponuje starší generací CPU, bylo do ní osazeno i odpovídají GPU, aby bylo možné výsledky aproximovat na reální produkční HW.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Lenovo ThinkStation D20}
	\item {Operační systém Windows 10 pro 64 bit}
    \item {CPU Intel(R) Xeon(R) X5670 @ 2.93 GHz (2×cpu, 6×core, 12×thread)}
    \item {RAM 32 GB DDR3 (1066)}
    \item {GPU NVIDIA GeForce GTX 460}
    \item {HDD SAS 10.000 ot}
\end{itemize}

\n{3}{Použitý SW}
V úvodní fázi projektu probíhal vývoj i testování algoritmů v Mathlabu.

\n{2}{Výsledky testování}
Byly realizovány dva testovací scénáře.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Výpočet čistě na CPU s maximálním využitím HW.}
	\item {Výpočet na CPU s využitím GPU pro paralelizaci vybraných procesů.}
\end{itemize}

\n{3}{CPU}
Výpočet na CPU byl spuštěn v pěti vláknech. Z počátku vypadal průběh velmi slibně. Bohužel při delším testu se výpočet začal značně propadat. Později se ukázalo, že hlavním důvodem je odložené uvolňování RAM. Jinými slovy dokud byla další volná RAM, výpočet jel velmi rychle. S potřebou uvolnit RAM se výpočet řádově snížil.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Krátkodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 5 minut}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 205 výpočtů obou koeficientů}
		\end{itemize}
	\item {Dlouhodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 6 hodin}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 31 výpočtů obou koeficientů}
		\end{itemize}
	\item {Propad o 85\%}
\end{itemize}

Na obrázku níže (Obr. \ref{fig:one-similarity-thread}) je výstup z profilování výpočtu na CPU. Obsahuje poměrově zvýrazněné dlouho trvající operace vůči zbytku procesu. V rámci profilování bylo zpracováno deset tisíc iterací a doby jednotlivých částí zprůměrovány.
\obr{Vizualizace procesu výpočtu koeficientů na CPU}{fig:one-similarity-thread}{1.0}{graphics/one-similarity-thread.png}

Celková zátěž alokovaného HW nebyla příliš slavná. Nepodařilo se efektivně využít CPU, které dosahovalo průměrné zátěže 30\% zejména kvůli neustálé realokaci operační paměti, na kterou čekalo zkrátka vše.
Úvodní myšlenka využít hrubou sílu produkčního HW se ukázala jako velmi špatná.

\n{3}{CPU + GPU}
Výpočet byl spuštěn v jednom vlákně na CPU. Vhodné operace pro GPU jsou delegovány pro paralelní zpracování.
Nejprve bylo na GPU paralelizován pouze úvodní scaling obrázků. To nemělo příliš valný dopad na výsledky. Následně byly paralelizovány na GPU také prováděné transformace obrázků. Právě tento krok měl zásadní vliv na zrychlení celé operace.
Je zde opět patrný lehký propad krátkodobého testu oproti dlouhodobému.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Krátkodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 5 minut}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 617 výpočtů obou koeficientů}
		\end{itemize}
	\item {Dlouhodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 6 hodin}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 559 výpočtů obou koeficientů}
		\end{itemize}
	\item {Propad o 10\%}
\end{itemize}

Na obrázku níže (Obr. \ref{fig:one-similarity-thread-with-gpu-paralelization}) je výstup z profilování výpočtu na CPU s využitím GPU pro paralelizací dlouhotrvajících operací na CPU. Obsahuje poměrově zvýrazněné dlouho trvající operace vůči zbytku procesu. V rámci profilování bylo zpracováno deset tisíc iterací a doby jednotlivých částí zprůměrovány.
\obr {Vizualizace procesu výpočtu koeficientů na CPU s paralelizací na GPU}{fig:one-similarity-thread-with-gpu-paralelization}{1.0}{graphics/one-similarity-thread-with-gpu-paralelization.png}

Zátěž na CPU dosahuje v průměru 5\%. Naopak GPU dosahuje zátěže cca 75\%. Otázkou zůstává, jak dlouho je schopná GPU pracovat pod tímto permanentním zatížením.

% ============================================================================ %
\cast{Projektová část}
\n{1}{Distribuovaná služba}

\n{2}{Fronta nezpracovaných obrázků}

\n{2}{Servlet pro stažení obrázků}

\n{2}{Odeslání výsledků}

\n{1}{Klient}

% ============================================================================ %
\nn{Závěr}
Text závěru


% ============================================================================ %
