% ============================================================================ %
% Encoding: UTF-8 (žluťoučký kůň úpěl ďábelšké ódy)
% ============================================================================ %

% ============================================================================ %
\nn{Úvod}
První odstavec pod nadpisem se neodsazuje, ostatní ano (pouze první řádek, odsazení vertikální mezy odstavci je typycké pro anglickou sazbu; czech babel toto respektuje, netřeba do textu přidávat jakékoliv explicitní formátování, viz ukázka sazby tohoto textu s následujícím odstavcem).

Formátování druhého odstavce. Text text text text text text text text text text text text.


% ============================================================================ %
\cast{Teoretická část}

\n{1}{Klasifikace řešených oblastí}
Pro porovnání dvou fotografií a jejich vzájemné vyhodnocení jako podobné či nikoliv bude zaveden koeficient podobnosti fotografií (dále jen KoP). Postupně budou popsány všechny silné i slabé stránky pro možnosti výpočtu KoP. Základem klasifikace je vymezení rozdílů mezi vzorovou a referenční fotografií, které definují konstruktivní a destruktivní změny.

\n{2}{Konstruktivní změny fotografie}
Konstruktivní změny fotografie jsou takové změny, které jsou viditelné pro lidské oko, avšak nemění zásadně charakter obrázku pro strojové zpracování. Možné změny (případně jejich kombinace) jsou rozvedeny níže.

\n{3}{Návrh řešení}
Pro porovnání dvou podobných fotografií, které obsahují pouze konstruktivní změny, plně postačí křížová korelace, která bude urychlena (v rámci optimalizace HW času) pomocí diskrétní Fourierovy transformace~\cite{FFT}.

\n{3}{Oblast zájmu}
Touto numerickou metodou lze detekovat většinu nejčastějších záměrných modifikací fotografií (např. automatické doostření a následné uložení jako kopie). Lze sem zahrnout jak změny vlastností vázané na původní fotografii, tak drobné změny v původním obsahu fotografie.

\n{4}{Změny vlastností}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Změna sytosti barev}
	\item{Změna kontrastu}
	\item{Změna jasu}
\end{itemize}

\n{4}{Změny obsahu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Vodotisk}
	\item{Logo}
	\item{Šum}
\end{itemize}

\n{2}{Destruktivní změny fotografie}
Destruktivní změny fotografie jsou viditelné pro lidské oko, ale pouze vjemem lidského oka je často problém tyto fotografie bezpečně prohlásit za podobné. Ještě horší situace je u strojového zpracování, pro které se výrazně mění charakter porovnávaných fotografií.

\n{3}{Návrh řešení}
Výpočet Hausdorfovy vzdálenosti mezi konvexními polyedry, které reprezentující hrany v obrazu~\cite{FFT-technique}.

\n{3}{Oblast zájmu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Změna komprese (rozmazaná fotografie)}
	\item{Změny rozlišení}
	\begin{itemize}
		\item{Ořez (v jedné nebo obou dimenzích)}
		\item{Deformace (v jedné nebo obou dimenzích)}
	\end{itemize}
\end{itemize}

\n{2}{Kombinace konstruktivních a destruktivních změn}
Kombinace konstruktivních a destruktivních změn je vždy potřeba vyhodnotit nad konkrétním případem. Platí také, že jsou velmi obtížně řešitelné. V závislosti na míře změn lze často rozpoznat KoP stejně jako u čistě konstruktivních změn.

\n{3}{Návrh řešení}
Redukce fotografie na její prahovou velikost jako příprava na křížovou korelaci viz konstruktivní změny~\cite{fftw3}.

\n{3}{Oblast zájmu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Asymetrická změna obou stran s čímkoliv}
	\item {Změna kvality v důsledku zhoršeni komprese s čímkoliv}
	\item {Logo nebo vodotisk v kombinaci s předcházejícími}
\end{itemize}

\n{2}{Výběr reprezentativního vzorku}
Pro skupinu vzájemně si podobných fotografií vybereme nejvhodnějšího kandidáta, který bude následně ostatní fotografie zastupovat. Jde o~experimentální postup.

\n{3}{Návrh řešení}
Bude zaveden koeficient zastupitelnosti (dále jen KoZ), který je zjednodušeně určen jako $ VELIKOST * OSTROST + JAS $. Přičemž platí, že vyšší hodnota koeficientu zastupitelnosti znamená kvalitnější fotografii (nikoliv na oko hezčí fotografii). Reprezentativní vzorek bude fotografie, která bude vybraná ze skupiny podobných fotografií na základě KoP, s nejvyšším KoZ.

\n{3}{Oblast zájmu}

\n{4}{Střední hodnota jasu}
je určena pomocí světlostní matice. Jedná se pouze o zohlednění, zda fotografie není příliš jasná nebo tmavá. Jde o~jednoduchý algoritmus. Na výsledek nemá zásadní vliv.

\n{4}{Poměrný počet hran}
slouží jako test rozmazanosti fotografie. K realizaci se používá konvoluční matice (více v samostatné kapitole věnované této problematice) s vhodným jádrem typu horní i dolní propusť (s celkovým součtem 0). Na výsledek má největší dopad.

\n{4}{Rozlišení fotografie}
je bráno jako klasická velikost fotografie v px (větší ⇔ lepší).

\n{1}{Koeficient podobnosti dvou fotografií}
Jde o základní ukazatel podobnosti dvou fotografií. KoP leží na intervalu $ <0,1> $. Přičemž hodnoty blížící se $ 1 $ symbolizují podobné fotografie. Interval podobnosti byl na základě testovacích pokusů stanoven na $ <0,07, 1) $. Hodnota $ 1 $ znamená duplicitní fotografii. Byla z intervalu vyloučena, jelikož jsou fotografie nejprve unifikovány pomocí otisku MD5~\cite{md5}.
Výpočet KoP provedeme v šesti krocích, z čehož jsou čtyři kroky přípravné (optimalizační) a pouze dva kroky reálně ovlivňují výsledný KoP.
\begin{enumerate}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Změna velikosti fotografie}
	\item {Převod na světlostní matici}
	\item {Převod do vlnového spektra}
	\item {Křížová korelace (Cross correlation method)}
	\item {Převod zpět z vlnového spektra}
	\item {Výpočet KoP z výsledné matice}
\end{enumerate}
Body 1 - 3 slouží jako přípravné a aplikují se na obě fotografie (vzorová a referenční). Do bodu 4 tedy vstupují dvě matice (pro každou fotografii jedna). Výstupem 4. bodu je již jen jedna matice, která je v bodě 6 vyhodnocena do výsledného KoP.

\n{2}{Změna velikosti fotografie}
Jedná se o nezbytný přípravný krok, jehož cílem je sjednotit u obou fotografií počet bodů a tím také počet prvků v maticích, které vzniknou v následujícím kroku výpočtu KoP.
Jako referenční velikost byla stanovena
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item Šířka: 320 px,
	\item Výška: 240 px,
\end{itemize}
které jsou nejvhodnějším kompromisem mezi relevancí výsledku a HW časem nutným k jeho zpracování.

Změna velikosti vzorové fotografie na $ [320 × ?] $ nebo $ [? × 240] $ se provádí v závislosti na delší straně. Kratší strana je dopočítána podle původního poměru stran. Výsledný rozměr není doplněn nulami na plnou referenční velikost $ [320 × 240] $. Vzorová fotografie tedy určuje velikost, na kterou musíme upravit referenční fotografii. Pokud má referenční fotografie jiný poměr stran, bude doplněna nulami, aby nevznikala prázdná místa.

Takto připravené fotografie nejsou při dalším zpracování komutativní, pokud mají vzájemně jiný poměr stran. V důsledku to znamená, že se musí porovnat fotografie v obou směrech (jak vzorová vůči referenční, tak referenční vůči vzorové). Situaci ukazují příklady na Obr.~\ref{fig:static-scaling} a Obr.~\ref{fig:dynamic-scaling}.

\obr{Statický scaling obrázků (komutativní)}{fig:static-scaling}{1.0}{graphics/static-scaling.png}

\obr{Dynamický scaling obrázků (diskomutativní)}{fig:dynamic-scaling}{1.0}{graphics/dynamic-scaling.png}

Přesto, že je tento proces HW dražší, než jeho komutativní varianta, získáme díky tomu řádově lepší relevanci výsledků (zejména pokud je jedna ze dvou fotografií velmi nekvalitní, případně má nižší nativní rozlišení, než je referenční).

\n{2}{Převod na světlostní matici}
Světlostní matice představuje fotografii ve formátu rastrové bitmapy (někdy též šedotónový obraz; v anglicky psaných textech k nalezení pod názvem brightness-matrix). Formálně je to dvourozměrná diskrétní veličina, reprezentovaná maticí druhého řádu~\cite{brightness-matrix}. Každý bod původní fotografie - pixel~\cite{pixel} (dále jen px) je z RGB~\cite{rgb} hodnot převeden na hodnotu intenzity jasové funkce.

Původní px je reprezentován jako tří prvkové pole s hodnotami na intervalu $ <0,255> $.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item R => red,
	\item G => green,
	\item B => blue,
\end{itemize}

Výsledná hodnota intenzity jasové funkce px se spočítá jako střední hodnota z hodnot jednotlivých složek px (R, G a B). Jak napovídá interval možných hodnot, jeden px převedený na prvek světlostní matice zabírá v operační paměti 1 Byte (1 Byte = 8 bit => osmibitová barevná hloubka => 256 stupňů šedi). Na jedenu plnou referenční fotografii je tedy potřeba 75 kB.

\n{2}{Převod do--z vlnového spektra}
Převodem do vlnového spektra dosáhneme zajímavé výkonnostní optimalizace~\cite{FFT}. Kdybychom tento krok z celého procesu výpočtu KoP vynechali (stejně jako následně nezbytný převod zpět z vlnového spektra), museli bychom udělat křížovou korelaci v normálním spektru. Tzn. $ O(n^4) $ operací, kde $ n $ je velikost strany čtvercové matice.

Pokud ale nejprve provedeme Diskrétní Fourierovu transformaci (DFT) pro převod do vlnového spektra, až následně křížovou korelaci a nakonec Zpětnou Fourierovu transformaci (IFT), ušetříme jeden řád hodnosti počtu operací. Budeme potřebovat $ O(n^3 * logn) $ operací. To je za předpokladu matice reprezentující fotografii 200 × 200 px rozdíl dvou řádů operací.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Klasické spektrum: $ 200^4 = 1.6 * 10^9 $ operací}
	\item{Vlnové spektrum: $ 200^3 * log 200 = 6.1 * 10^7 $ operací}
\end{itemize}

\n{2}{Křížová korelace}
Korelace je nejdůležitější krok celého výpočtu KoP. Umožní pomocí jednoduchých matematických operací rozhodnout, zda jsou světlostní matice vzorové a referenční fotografie podobné. Míra podobnosti je vyjádřena hodnotami korelačních koeficientů sestavených do jedné matice (zatím ještě ve vlnovém spektru). Čím více se výsledné hodnoty blíží $ 1 $, tím více si jsou fotografie podobné v daném bodě.

Celý proces není citlivý na konstruktivní změny. Dokáže tedy podobnost vyhodnotit bez ohledu na změnu sytosti barev, kontrastu či jasu. Stejně tak výsledek není ovlivněn přidáním vodotisku nebo šumem ve fotografii. Přidání loga do fotografie již sice sníží KoP, ale pokud není logo přes polovinu fotografie, je stále bezpečně rozpoznána jako podobná či nikoliv.

Formálně je korelace zejména statistický pojem, který označuje vzájemný lineární vztah mezi znaky nebo veličinami. Míra korelace je daná korelačním koeficientem~\cite{correlation}. 
Vzorec pro výpočet: $ \rho_{A,B} = \dfrac{(A - \mu_{A}) × (B - \mu_{B})}{\sigma_{A}\sigma_{B}} $

Na první pohled se může zdát složitý, ale skrývá v sobě tři jednoduché ale důležité kroky.
\begin{enumerate}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{K maticím $ A $ a $ B $ se spočítá rozptyl $ \sigma_{A}, \sigma_{B} $ a střední hodnota $ \mu_{A}, \mu_{B} $.}
	\item{Odečtením střední hodnoty od matice $ A - \mu_{A} $, $ B - \mu_{B} $ je dosaženo \textbf{invariace nastavení jasu}.}
	\item{Dělením rozptyly $ \sigma_{A} \sigma_{B} $ je zajištěna \textbf{invariace nastavení kontrastu}.}
\end{enumerate}

Za předpokladu, že objekty na porovnávaných fotografiích nejsou vůči sobě v prostoru posunuty, poskytuje korelační matice odpověď na otázku, zda jsou si dvě fotografie podobné. V praxi ale tento model příliš nenastává. Naopak je velmi časné, že je porovnáván např. výřez z fotografie oproti originálu, případně posunuté fotografie po horizontální či vertikální ose.

Tuto problematiku řeší křížová korelace (Cross correlation method)~\cite{cross-correlation}. Princip samotné korelace je stejný, pouze se opakuje s částečným posunem tak, aby pokryla všechny možné kombinace mezi dvěma fotografiemi. Příklad je názorně vidět na původních fotografiích, jak ukazuje (Obr.~\ref{fig:correlation}) a (Obr.~\ref{fig:cross-correlation}).

\obr{Příklad proložení dvou fotografií s použitím klasické korelace}{fig:correlation}{1.0}{graphics/correlation.png}

\obr{Příklad proložení dvou fotografií s použítím křížové korelace}{fig:cross-correlation}{1.0}{graphics/cross-correlation.png}

\n{2}{Výpočet výsledného koeficientu}
Po převodu z vlnového spektra zpět vychází již matice, ze které jsou vyloučeny imaginární hodnoty a pracujeme tedy jen s reálnými čísly. Výsledný KoP pro dané fotografie je dán nejvyšším nalezeným korelačním koeficientem v matici.

\n{1}{Koeficient zastupitelnosti dvou fotografií}
Určení KoZ je experimentální proces založený na opakované aplikaci konvoluční matice s různým jádrem (konvoluční maskou). Bude jí věnována větší pozornost v projektové části. Zde budou představeny pouze techniky nutné k jejímu dosažení. Jelikož převod na světlostní matici a převod z--do vlnového spektra byly již představeny, nebudou dále znovu uvedeny.

\n{2}{Diskrétní 2D konvoluce}
Konvoluce~\cite{convolition} je matematický operátor pro zpracování dvou funkcí. V algoritmech zpracovávající dvourozměrný diskrétní obraz (např. v počítačové grafice) má konvoluce následující tvar:
$ (f*h)(x,y)=\sum\limits_{i=-k}^{k} \sum\limits_{i=-k}^{k} f(x-i,y-j) \bullet h(i,j)$

Názorná ukázka konvoluce je vidět na přiloženém obrázku (Obr.~\ref{fig:discrete-2d-convolution}).

\obr{Příklad Diskrétní 2D konvoluce~\cite{convolition}}{fig:discrete-2d-convolution}{1.0}{graphics/discrete-2d-convolution.jpg}

\n{2}{Konvoluce a volba jádra}
Konvoluce ve světě počítačové grafiky je operace s obrázkem ve formátu matice pomocí jiné matice zvané „jádro“ (nebo též konvoluční maska). Jako první matice se používá obrázek určený k úpravě. Obrázek představuje dvojrozměrnou pravoúhlou souřadnicovou síť pixelů. Použité jádro závisí na požadovaném efektu.

V našem případě je požadovaný filtr na detekci hran~\cite{edge-detection}. Základní jádra pro detekci hran mají součet roven nule (Tab.~\ref{tab:convolution-core-4} a Tab.~\ref{tab:convolution-core-8}). Nejsou vhodné na obrázky zatížené šumem. Ten je nezbytné před aplikací těchto filtrů eliminovat.

\tab {Jádro pro detekci hran (horizontálně a vertikálně)} {tab:convolution-core-4} {1.0}
	{|r|r|r|}
	{\hline
	0 & 1 & 0 \\
	\hline
	1 & -4 & 1 \\
	\hline
	0 & 1 & 0 \\
	\hline}
\tab {Jádro pro detekci hran (horizontálně, vertikálně a šikmé hrany)} {tab:convolution-core-8} {1.0}
{|r|r|r|}
{\hline
	1 & 1 & 1 \\
	\hline
	1 & -8 & 1 \\
	\hline
	1 & 1 & 1 \\
	\hline}

% ============================================================================ %

% Pokud Vaše práce neobsahuje analytickou část, stačí odstranit či zakomentovat nasledujících pár rádků
\cast{Analytická část}

\n{1}{Brainstorming}
Tato analytická metoda slouží ke sběru myšlenek, námětů a případné zevrubné konstruktivní kritice dané problematiky. V rámci této práce byla použita v akademickém a profesním kruhu za účelem identifikace základních ukazatelů pro další kroky analýzy.

\n{2}{Akademický kruh}
Diskutovány byly zejména technické možnosti týkající se otázek kde a jak lze vůbec porovnání fotografií provádět strojově. K další analýze byly vyb

\n{2}{Profesní kruh}
V kruhu s provozovatelem byly kladeny nejvyšší nároky na flexibilitu a propustnost celého řešení.

\n{1}{Diferenční analýza (GAP analýza)}

\n{2}{Popis současného stavu}
Je požadováno porovnání rastrových bitmap za účelem identifikace vzájemně podobných fotografií. Řešení je hledáno pro produkční provoz. Konzumentem cílového řešení je webový portál dovolena.cz, který má přibližně dva miliony fotografií. Průměrný počet přístupů k některé fotografii je přibližně 100 přístupů za sekundu. Obsahem fotografií jsou především hotely a jejich okolí. Webový portál slouží spíše jako datový konsolidátor. Nabídka portálu značně ovlivňuje cílové portfolio fotografií. Podle testovacích měření se za jeden týden obmění cca 10\% fotografií z celkového množství. Jako testovací vzorek byl vybrán jeden nejmenovaný hotel a jeho 35 fotografií. Zákazník webového portálu vidí všechny fotografie v nesetříděné galerii. Některé fotografie jsou unikátní, ale většina si je velmi podobná. U některých dokonce nejsou lidským okem patrné rozdíly.

\n{2}{Popis cílového stavu}
Konsolidované fotografie prezentované klientovi budou v maximální možné míře obsahovat unikátní fotografie. Vzájemně si podobné fotografie budou odfiltrovány a zůstane pouze jedna a to fotografie s nejvyšším KoZ. Klient nebude čekat na zpracování podobnosti obrázků. Pokud budou zpracované, klient uvidí jen unikáty. Pokud nebudou zpracované, klient uvidí vše v původním stavu. V takovém případě se poměrově zvýší priorita na výpočet podobnosti fotografií tohoto hotelu vůči ostatním ve frontě na výpočet. Cílové řešení musí být schopno operovat řádově s jednotkami milionů fotografií s týdenní fluktuací 15\%.

\n{3}{Nefunkční požadavky}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Bezúdržbový systém}
	\item {Nevyžadující v průběhu času další financování}
	\item {Minimální vstupní investice}
	\item {Maximální kompatibilita s aktuálním HW}
	\item {Programovací jazyk Java~\cite{java}}
\end{itemize}

\n{2}{Rozdíly}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Nově vznikne nástroj pro určení KoP.}
	\item {Nově vznikne nástroj pro určení KoZ.}
	\item {Fotografie jednoho hotelu budou oindexovány a vnitřně škálovány do skupin pomocí koeficientů výše.}
	\item {Dojde k navýšení celkového počtu fotografií.}
	\item {Zvýší se fluktuace fotografií (na očekávaných 15\%).}
\end{itemize}

\n{2}{Návrh variant k dosažení cíle}
Pilířem celého řešení bude backendová strana cílového konzumenta. Limity a také jednotlivé možnosti pro realizaci jsou velmi omezeny nutností integrovat do současného řešení. Z těchto důvodů má serverová strana převážně podpůrný charakter v projektu jako celku. Její význam je zejména v propojení všech jednotlivých komponent. Dojde tedy k modifikaci existujícího produkčního server-side prostředí. Nově zde poběží služba, která bude
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {poskytovat zadání na určení KoP,}
	\item {poskytovat metadata nezbytná pro distribuci výpočtu,}
	\item {konzumovat výsledek distribuované operace,}
	\item {kompletovat zpracovaná data do cache vhodné pro silný organický provoz.}
\end{itemize}
Naopak klientská strana je naprosto autonomní. Pro realizaci lze použít jak libovolnou platformu, tak libovolné technologie. Jediným technickým limitem je schopnost standardizovaným způsobem komunikovat se serverovou stranou pomocí SOAP api~\cite{soap}.

\n{3}{Výpočet KoP a KoZ na CPU produkčního serveru}
Základní myšlenka je využít nejdostupnější produkční HW a na zavedeném serveru spustit novou službu. Hlavní výhodou je dostupnost produkčního HW ve vlastním datacentru cílového konzumenta. Podstatnou nevýhodou je fakt, že pro určení výše uvedených koeficientů není CPU~\cite{cpu} ideální platforma.

\n{3}{Výpočet KoP a KoZ na CPU produkčního serveru s paralelizací na GPU}
Tento způsob předpokládá osazení produkčního serveru dedikovanou pracovní grafickou kartou a vybrané části procesu výpočtu KoP a KoZ optimalizovat pro zpracování na GPU~\cite{gpu}.

\n{3}{Výpočet koeficientů na PC farmě}
Způsob předpokládá využití HW osobních PC, kterých je v každé větší společnosti dostatek. Výpočet koeficientů tedy není nutno provádět na jednom stroji, ale lze jej provádět na každém dostupném stroji.

\n{2}{Zhodnocení variant}
Jako nejvýhodnější varianta pro realizaci vychází PC farma. Jako záložní řešení lze využít produkční server s výpočtem na CPU. Pokud bude zvolen vhodný programovací jazyk (např. požadovaný programovací jazyk Java~\cite{java}), bude výsledné řešení přenositelné.

Zhodnocení výkonových rozdílů vychází z benchmarkingu, který byl vyhodnocen jako pomocná analýza uvedená níže. Zhodnocení prezentuje tabulka (Tab.~\ref{tab:banchmark}) 

\tab {Tabulka výsledků jednotlivých variant krátkodobého testu} {tab:banchmark} {1.0}
{|l|l|l|l|}
{\hline
		Varianta			& Týdenní přírůstek	& Všechny fotografie	& Teoretická rezerva	\\
\hline
		CPU 				& 6 dní				& 27 týdnů				& 3,7\%					\\
\hline
		GPU 				& 8 hodin			& 2 dny 2 hodiny		& 300\%					\\
\hline
		PC farma (300 ks)	& 2,5 hodin			& 16 hodin				& 700\%					\\
\hline}

Zhodnocení investičních rozdílů ukazuje tabulka (Tab.~\ref{tab:investment}). Vychází z předpokladu, že $ x $ je investiční konstanta v Kč, vztažená na cenu jednoho produkčního serveru bez GPU. Pro zjednodušení je stanovena na 100.000 Kč (není příliš daleko od reality).

\tab {Tabulka výsledků jednotlivých variant krátkodobého testu} {tab:investment} {1.0}
{|l|l|l|}
{\hline
	Varianta			& Pořizovací cena [Kč]	& Nutná investice [Kč]			\\
	\hline
	CPU 				& $ x $					& $ 0 $							\\
	\hline
	GPU 				& $ 10x $				& $ 10x $						\\
	\hline
	PC farma (300 ks)	& $ 30x $				& $ 0 $							\\
	\hline}

\n{3}{Výpočet KoP a KoZ na CPU produkčního serveru}
\n{4}{Výsledky banchmarkingu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Za necelých 6 dní spočítá týdenní přírůstek.}
	\item {Za zbylou dobu z týdenního cyklu dále vypočítá přibližně 3,7\% z celkového objemu sto milionu koeficientů.}
	\item {Pro plné vypočítání všech koeficientů potřebuje dalších cca 27 týdnů.}
	\item {Rezerva pro další růst (navýšení celkového počtu fotografií) je cca 18\%.}
\end{itemize}

\n{3}{Výpočet KoP a KoZ na CPU produkčního serveru s paralelizací na GPU}
\textbf{Pro realizaci tohoto scénáře je nezbytná vysoká vstupní investice.} Běžně dostupný produkční server nedisponuje GPU. Pořizovací cena takového serveru je řádově vyšší. Dále je nutné připočíst cenu vlastní dedikované grafické karty, která cenově převyšuje cenu serveru. Její výběr je velmi omezen kompatibilitou s produkčními servery. Zástupce firmy Dell byl schopen nacenit na vlastní server pouze dvě karty s možností garancí non-stop provozu a výměnou do 24 hodin.

\n{4}{Výsledky banchmarkingu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Za necelých 8 hodin spočítá týdenní přírůstek.}
	\item {Za část ze zbylé doby týdenního cyklu dále vypočítá 100\% z celkového objemu sto milionu koeficientů.}
	\item {Pro plné vypočítání všech koeficientů potřebuje celkem 2 dny.}
	\item {Rezerva pro další růst (navýšení celkového počtu fotografií) je cca 300\%.}
\end{itemize}

\n{3}{Výpočet koeficientů na PC farmě}
Výsledek jednoho kancelářského PC je zanedbatelný a nemůže se rovnat předchozím variantám. Vezmeme-li v úvahu, že těchto strojů je k dispozici 300 kusů po dobu 16 hodin denně, posunou se výsledky na jinou úroveň.

\n{4}{Výsledky banchmarkingu}
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Za 2,5 hodiny spočítá týdenní přírůstek (za předpokladu 300 aktivních PC).}
	\item {Za část ze zbylé doby týdenního cyklu dále vypočítá 100\% z celkového objemu sto milionu koeficientů.}
	\item {Pro plné vypočítání všech koeficientů potřebuje celkem 16 hodin, což je v tomto případě 1 den.}
	\item {Rezerva pro další růst (navýšení celkového počtu fotografií) je cca 700\%.}
\end{itemize}

Tento krok předpokládá mimo jiné i revizi infrastruktury, především kvalitu a šířku pásma sítě, centrální správu PC apod., které v této fázi nejsou zahrnuty do hodnotících kritérií.

\n{1}{Benchmarking}
Jednotlivé kandidáty pro realizaci klientské části (zavedené v diferenční analýze) podrobíme výkonnostním a srovnávacím testům.
Základní předpoklady:
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Řádově je potřeba jednorázově odbavit $ 100.000.000 $ výpočtů KoP.}
	\item {Řádově je potřeba jednorázově odbavit $ 2.000.000 $ výpočtů KoZ.}
	\item {Na týdenní bázi následně odbavovat přírůstky řádově}
	\begin{itemize}
		\setlength{\parskip}{0pt}
		\setlength{\itemsep}{0pt}
		\setstretch{1.05}
		\item {$ 15.000.000 $ výpočtů KoP,}
		\item {$ 300.000 $ výpočtů KoZ}.
	\end{itemize}
\end{itemize}

\n{2}{Testovací prostředí}

\n{3}{Použitý HW}

\n{4}{Simulace produkčního serveru}
je založena na pracovní stanici Lenovo D20, která je svoji sestavou velmi blízko produkčnímu serveru. Vzhledem k tomu, že disponuje starší generací CPU, bylo do ní osazeno i odpovídají GPU, aby bylo možné výsledky aproximovat na reálný produkční HW.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Lenovo ThinkStation D20}
	\item {Operační systém Windows 10 pro 64 bit}
    \item {CPU Intel(R) Xeon(R) X5670 @ 2.93 GHz (2×cpu, 6×core, 12×thread)}
    \item {RAM 32 GB DDR3 (1066)}
    \item {GPU NVIDIA GeForce GTX 460}
    \item {HDD SAS 10.000 ot}
\end{itemize}

\n{4}{Simulace klasického PC}
pro je založena na PC Dell Optiplex 780. Obecně je to velmi rozšířený kancelářský PC. Taktéž cílový konzument disponuje více než 300 ks odpovídajících kancelářských PC. Tato simulace je omezena pouze na výpočty na CPU.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Dell Optiplex 780}
	\item {Operační systém Windows 7 pro 32 bit}
	\item {CPU Intel Core 2 Duo E7500 2,93 GHz}
	\item {RAM 4 GB DDR3}
	\item {HDD SATA 250 GB}
\end{itemize}

\n{3}{Použitý SW}
V úvodní fázi projektu probíhal vývoj i testování algoritmů v Matlabu~\cite{matlab}. Ten vnitřně používá pro zpracování DFT a IFT knihovnu FFTW~\cite{fftw}. Tato knihovna má dostupnou nativní implementaci v CMake~\cite{cmake}. Dále má pro řadu programovacích jazyků (včetně programovacího jazyku Java~\cite{FFT-java}) připravený wrapper~\cite{wrapper}.

\n{4}{Algoritmu v matlabu (výpočet KoP na CPU)}
banchmark-cpu.m

\lstinputlisting[style=Matlab-editor,basicstyle=\mlttfamily\tiny]{code/matlab/banchmark-cpu.m}
Výsledný KoP odpovídá proměnné ccCMax.

\n{4}{Algoritmus v matlabu (výpočet KoP s paralelizací na GPU)}
banchmark-gpu.m
\lstinputlisting[style=Matlab-editor,basicstyle=\mlttfamily\tiny]{code/matlab/banchmark-gpu.m}
Výsledný KoP odpovídá proměnné ccCMax.

\n{4}{Algoritmus v matlabu (výpočet KoZ na CPU)}
banchmark-koz-cpu.m
\lstinputlisting[style=Matlab-editor,basicstyle=\mlttfamily\tiny]{code/matlab/banchmark-koz-cpu.m}
Výpočet KoZ byl po provedení testů ve srovnávacích testech zanedbán. Především proto, že se nemusí počítat pro kombinace fotografií, ale právě jednou pro každou fotografii a to při jejím pořízení. Průměrná doba výpočtu KoZ je 620 ms.

\n{2}{Výsledky testování}
Byly realizovány tři testovací scénáře.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Výpočet čistě na CPU s maximálním využitím produkčního HW.}
	\item {Výpočet na CPU s využitím GPU pro paralelizaci vybraných procesů.}
	\item {Výpočet čistě na CPU na PC farmě.}
\end{itemize}

\n{3}{Výpočet koeficientů na CPU}
Výpočet na CPU byl spuštěn v pěti vláknech. Po spuštění probíhal výpočet velmi slibně. Bohužel při delším testu se výpočet začal značně propadat. Později se ukázalo, že hlavním důvodem je odložené uvolňování RAM. Jinými slovy dokud byla další volná RAM, výpočet jel velmi rychle. S potřebou uvolnit RAM se výpočet řádově snížil.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Krátkodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 5 minut}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 205 výpočtů obou koeficientů}
		\end{itemize}
	\item {Dlouhodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 6 hodin}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 31 výpočtů obou koeficientů}
		\end{itemize}
	\item {Propad o 85\%}
\end{itemize}

Na obrázku níže (Obr.~\ref{fig:one-similarity-thread}) je výstup z profilování výpočtu na CPU. Obsahuje poměrově zvýrazněné dlouho trvající operace vůči zbytku procesu. V rámci profilování bylo zpracováno deset tisíc iterací a doby jednotlivých částí zprůměrovány.
\obr{Vizualizace procesu výpočtu koeficientů na CPU}{fig:one-similarity-thread}{1.0}{graphics/one-similarity-thread.png}

Celková zátěž alokovaného HW byla oproti očekávání výrazně nižší. Nepodařilo se efektivně využít CPU, které dosahovalo průměrné zátěže 30\%. Hlavní problém je realokace operační paměti. Jednotlivé procesy pak čekají na přidělení operační paměti. Úvodní myšlenka využít hrubou sílu produkčního HW se ukázala jako nevyhovující.

\n{3}{Výpočet koeficientů na CPU s paralelizací na GPU}
Výpočet byl spuštěn v jednom vlákně na CPU. Vhodné operace pro GPU jsou delegovány pro paralelní zpracování.
Nejprve byl na GPU paralelizován pouze úvodní scaling obrázků, což nemělo přijatelný dopad na výsledky. Následně byly paralelizovány na GPU také prováděné transformace obrázků. Právě tento krok měl zásadní vliv na zrychlení celé operace.
Je opět patrný mírný propad krátkodobého testu oproti dlouhodobému.
\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Krátkodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 5 minut}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 617 výpočtů obou koeficientů}
		\end{itemize}
	\item {Dlouhodobý test}
		\begin{itemize}
			\setlength{\parskip}{0pt}
			\setlength{\itemsep}{0pt}
			\setstretch{1.05}
			\item {doba: 6 hodin}
			\item {počet opakování testu: 10}
			\item {průměrně za sekundu: 559 výpočtů obou koeficientů}
		\end{itemize}
	\item {Propad o 10\%}
\end{itemize}

Na obrázku níže (Obr.~\ref{fig:one-similarity-thread-with-gpu-paralelization}) je výstup z profilování výpočtu na CPU s využitím GPU pro paralelizací dlouhotrvajících operací na CPU. Obsahuje poměrově zvýrazněné dlouho trvající operace vůči zbytku procesu. V rámci profilování bylo zpracováno deset tisíc iterací a doby jednotlivých částí zprůměrovány.
\obr {Vizualizace procesu výpočtu koeficientů na CPU s paralelizací na GPU}{fig:one-similarity-thread-with-gpu-paralelization}{1.0}{graphics/one-similarity-thread-with-gpu-paralelization.png}

Zátěž na CPU dosahuje v průměru 5\%. Naopak GPU dosahuje zátěže cca 75\%. Otázkou zůstává, jak dlouho je schopná GPU pracovat pod tímto permanentním zatížením.

\n{3}{Výpočet koeficientů na PC farmě}
Výpočet byl spuštěn v jednom pracovním vlákně s omezenou možností alokace RAM na 1GB. Jedná se v podstatě o alternativu výpočtu obou koeficientů čistě na CPU. Tomu odpovídal i celkový průběh zpracování, který byl téměř stejný, pouze s nižší dotací vypočítaných dvojic koeficientů.
Lze tedy přejít rovnou na výsledky, jelikož samotné zpracování nic nového nepřineslo.

\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item {Krátkodobý test}
	\begin{itemize}
		\setlength{\parskip}{0pt}
		\setlength{\itemsep}{0pt}
		\setstretch{1.05}
		\item {doba: 5 minut}
		\item {počet opakování testu: 10}
		\item {průměrně za sekundu: 10 výpočtů obou koeficientů}
	\end{itemize}
	\item {Dlouhodobý test}
	\begin{itemize}
		\setlength{\parskip}{0pt}
		\setlength{\itemsep}{0pt}
		\setstretch{1.05}
		\item {doba: 6 hodin}
		\item {počet opakování testu: 10}
		\item {průměrně za sekundu: 6 výpočtů obou koeficientů}
	\end{itemize}
	\item {Propad o 40\%}
\end{itemize}

Zátěž na CPU je konstantní. Jedno jádro ze dvou jede permanentně na 100\%. Celková zátěž CPU tedy 50\%. Vzhledem k tomu, že stoj již netrpěl na realokaci paměti, je v případě PC úzkým hrdlem opravdu CPU. Ostatní sledované metriky (vytížení HDD, síťový provoz, pracovní teplota) se příliš nevychýlily z normálu.

% ============================================================================ %
\cast{Projektová část}




\n{1}{Příprava projektu}


\n{2}{HW Architektura}

\n{3}{Pohled na aktuální HW mapu}
\obr {L1 pohled aktuálního stavu}{fig:L1-now}{0.8}{graphics/yed/hw-architecture-now.eps}

\n{3}{Pohled na plánovanou HW mapu}
\obr {L1 pohled cílového stavu}{fig:L1-tobe}{0.8}{graphics/yed/hw-architecture-tobe.eps}


\n{2}{Požadavky}

\n{3}{Funkční požadavky}
Klasifikaci funkčních požadavků systému znázorňuje obrázek (Obr. \ref{fig:functional-requirements}).
\obr {Funkční požadavky}{fig:functional-requirements}{1.0}{graphics/ea/functional-requirements.png}

\n{3}{Nefunkční požadavky}
Klasifikaci nefunkčních požadavků systému znázorňuje obrázek (Obr. \ref{fig:non-functional-requirements}).
\obr {Nefunkční požadavky}{fig:non-functional-requirements}{1.0}{graphics/ea/non-functional-requirements.png}


\n{2}{Případy použití}

\n{3}{Aktéři}
Klasifikace aktérů (Obr. \ref{fig:actors}).
\obr {Aktéři}{fig:actors}{1.0}{graphics/ea/actors.png}

\n{3}{Případy užití}
Klasifikaci případů použití znázorňuje obrázek (Obr. \ref{fig:use-case}).
\obr {Případy užití}{fig:use-case}{1.0}{graphics/ea/use-case.png}


\n{2}{Modely}

\n{3}{Model tříd}
Identifikované datové modely jsou znázorněny pomocí modelu třídy na obrázku níže (Obr. \ref{fig:class-model})
\obr {Model tříd}{fig:class-model}{1.0}{graphics/ea/class-model.png}

\n{3}{Model služeb}
Identifikované backendové služby jsou znázorněny na obrázku níže (Obr. \ref{fig:bean-model})
\obr {Model služeb}{fig:bean-model}{1.0}{graphics/ea/bean-model.png}


\n{2}{Sekvenční diagram distribuované služby}
Na obrázku níže (Obr. \ref{fig:sq-similarity-worker}) je znázorněn sekvenční diagram přibližující odbavení výpočtu KoF.
\obr {Sekvenční diagram}{fig:sq-similarity-worker}{1.0}{graphics/ea/sq-similarity-worker.png}



\n{1}{Serverová (sběrná) strana distribuované služby}

\n{2}{Databelizace fotografií}

Proces určení KoZ je již trochu složitější. Nejprve je představen zjednodušeně a následně budou jednotlivé kroky rozvedeny.

\begin{itemize}
	\setlength{\parskip}{0pt}
	\setlength{\itemsep}{0pt}
	\setstretch{1.05}
	\item{Převod fotografie (Obr.~\ref{fig:sharpness-original}) na světlostní matici}
	\item{Převod světlostní matice do vlnového spektra pomocí DFT}
	\item{Sestavení matice ostrosti (matice hran)}
	\begin{itemize}
		\setlength{\parskip}{0pt}
		\setlength{\itemsep}{0pt}
		\setstretch{1.05}
		\item {Převod světlostní matice ve vlnovém spektru na matici hran (Obr.~\ref{fig:sharpness-matrix}),}
		\item {za pomocí konvoluce typu horní propusť.}
	\end{itemize}
	\item{Sestavení matice přeostřenosti, tj. matice hran za prahovou hodnotou (Obr.~\ref{fig:oversharpness-matrix})}
	\begin{itemize}
		\setlength{\parskip}{0pt}
		\setlength{\itemsep}{0pt}
		\setstretch{1.05}
		\item {Převod matice ostrosti ve vlnovém spektru na matici přeostřených hran,}
		\item {za pomocí konvoluce typu horní propusť.}
	\end{itemize}
	\item{Převod vypočtených matic zpět z vlnového spektra pomocí IFT.}
	\item{Sečtení hran v matici ostrosti a sečtení přeostřených hran v matici přeostřenosti.}
	\item{Podíl sumy hran a sumy přeostřených hran je KoZ.}
\end{itemize}

\n{4}{Příklad}
představu, jak tento proces funguje, prezentuje obrázek  (Obr.~\ref{fig:sharpness-example}). Po oddělení přeostřených hran (Obr.~\ref{fig:oversharpness-matrix}), od všech hran (Obr.~\ref{fig:sharpness-matrix}) je již snadné vypočítat jejich poměrný koeficient.

\begin{figure}[!ht]
	\centering
	\subfloat[Fotografie před úpravou] {{\includegraphics[width=11cm]{graphics/sharpness-original.png} \label{fig:sharpness-original}}}%
	\qquad
	\subfloat[Vizualizace hran] {{\includegraphics[width=11cm]{graphics/sharpness-matrix.png} \label{fig:sharpness-matrix}}}%
	\qquad
	\subfloat[Vizualizace přeostřených hran] {{\includegraphics[width=11cm]{graphics/oversharpness-matrix.png} \label{fig:oversharpness-matrix}}}%
	\caption{Příklad přeostřenosti fotografie}%
	\label{fig:sharpness-example}%
\end{figure}

Hlavní část určení KoZ je čistě experimentální, jelikož nebyl nalezen žádný srovnatelný vzorek či projekt, na kterém by šlo empiricky stavět.

Je nutné ručně nastavit do algoritmu některé konstanty (např. Negativní koeficient konvolučního jádra pro horní propusť) a jejich správnost následně testovat. Výsledkem je neutrální podklad z kterého “vystupují” hrany, velké množství hran ⇔ fotka není rozmazaná.


1. horní propusť - obraz hran
2. dolní propusť na obrazu hran - tím docílíme odstraněním velmi ostrých hran (přeostřenosti)
-- tím spočítám počet ostrých hran
Obrázek 

\n{2}{Fronta nezpracovaných obrázků}

\n{2}{Servlet pro stažení obrázků}

\n{2}{Odeslání výsledků}

\n{1}{Klientská (výkonná) strana distribuované služby}

%\lstinputlisting[style=Matlab-editor,language=java,basicstyle=\mlttfamily\tiny]{code/java/ImageComparatorWithConstantScale.java}

%\section{Java}
%\begin{lstlisting}[style=Matlab-editor,language=java,basicstyle=\mlttfamily\tiny]
% class HelloWorldApp {
%  public static void main(String[] args) {
%    System.out.println("Hello World!"); // Display the string.
%    for (int i = 0; i < 100; ++i) {
%      System.out.println(i);
%    }
%  }
%}
%\end{lstlisting}

%\lstinputlisting[language=Java,basicstyle=\mlttfamily\tiny]{code/matlab/ImageComparatorWithConstantScale.java}


% ============================================================================ %
\nn{Závěr}
Text závěru


% ============================================================================ %